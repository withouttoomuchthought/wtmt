<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>magicmirror ü™û‚ú® ¬∑ withouttoomuchthought</title>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;600&family=Karla:wght@300;400;600&display=swap');

        /* RESET */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        /* ROOT VARIABLES */
        :root {
            /* WTMT Palette */
            --butter: #FDF2B3;
            --peach: #FAD4C0;
            --lilac: #D9D7F3;
            --sky: #C7E5F5;
            --sage: #D7CBB3;
            --gold: #E3C27D;
            --cream: #FAF9F6;
            --ink: #2F2F2F;
            --text: #5A5A5A;

            /* UI Tokens */
            --glass: 255, 255, 255;
            --blur: 18px;
            --radius: 26px;
            --shadow: 0 20px 40px rgba(0,0,0,.12);

            /* Dynamic Background Gradient */
            --gradient-1: #B8A8D8;
            --gradient-2: #A8B8E8;
            --gradient-3: #B8A8E8;
            --gradient-4: #C8B8E8;

            /* Typography */
            --font-title: 'Playfair Display', serif;
            --font-body: 'Karla', -apple-system, BlinkMacSystemFont, sans-serif;

            /* Responsive text */
            --font-h1-mobile: 28px;
            --font-h1-desktop: 40px;

            --font-body-mobile: 16px;
            --font-body-desktop: 18px;

            --line-height-body: 1.6;
        }

        /* BODY */
        body {
            font-family: var(--font-body);
            font-size: var(--font-body-mobile);
            line-height: var(--line-height-body);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;

            /* Gradient Animation */
            background: linear-gradient(135deg,
                var(--gradient-1) 0%,
                var(--gradient-2) 35%,
                var(--gradient-3) 65%,
                var(--gradient-4) 100%);
            animation: gradientFlow 22s ease infinite;
            background-size: 400% 400%;
            background-attachment: fixed;

            position: relative;
            overflow-x: hidden;

            /* Desktop magic cursor only */
            cursor: none;
        }

        @media (min-width: 1024px) {
            body { font-size: var(--font-body-desktop); }
        }

        @media (hover: none) and (pointer: coarse) {
            body { cursor: auto !important; }
        }

        /* BACK BUTTON */
        .back-btn {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 100;
            padding: 8px 16px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.7);
            background: rgba(255,255,255,0.55);
            backdrop-filter: blur(18px);
            font-size: 0.8rem;
            color: var(--ink);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.12);
            transition: all .2s ease;
        }
        .back-btn:hover {
            transform: translateY(-1px);
            background: rgba(255,255,255,0.8);
        }

        /* CUSTOM CURSOR ‚Äî desktop only */
        .custom-cursor,
        .cursor-follower {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
        }

        .custom-cursor {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,.9);
            box-shadow: 0 0 15px rgba(212,197,226,0.6);
            transition: transform .15s ease;
        }

        .cursor-follower {
            width: 35px;
            height: 35px;
            border: 2px solid rgba(212,197,226,0.4);
            border-radius: 50%;
            transition: transform .25s ease;
        }

        @media (hover: none) and (pointer: coarse) {
            .custom-cursor,
            .cursor-follower { display: none !important; }
        }

        /* AURORA LIGHT BEAMS */
        .aurora-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 1;
        }
        .aurora-beam {
            position: absolute;
            width: 300px;
            height: 200%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(232,214,255,.15) 50%,
                transparent 100%
            );
            filter: blur(40px);
            animation: auroraMove 20s ease-in-out infinite;
            transform-origin: top center;
        }

        /* RIPPLE CANVAS */
        #rippleCanvas {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 2;
        }

        /* PARTICLES */
        .particle-system {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 3;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            opacity: 0;
            animation: floatParticle linear infinite;
        }
        .particle.slow {
            width: 2px; height: 2px;
            background: rgba(255,255,255,.6);
        }
        .particle.fast {
            width: 3px; height: 3px;
            background: rgba(212,197,226,.7);
        }
        .particle.glow {
            width: 5px; height: 5px;
            background: radial-gradient(circle,
                rgba(255,255,255,.9),
                rgba(249,228,166,.5)
            );
        }

        /* CLOUD SYSTEM */
        .cloud-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .parallax-cloud {
            position: absolute;
            background: rgba(255,255,255,.15);
            border-radius: 50% 40% 45% 55% / 55% 45% 50% 50%;
            filter: blur(25px);
            opacity: 0;
            animation: driftParallax linear infinite;
        }

        .quote-cloud {
            position: absolute;
            background: rgba(255,255,255,.25);
            backdrop-filter: blur(15px);
            border-radius: 18px;
            padding: 12px 18px;
            font-size: .75em;
            color: rgba(0,0,0,.35);
            text-align: center;
            opacity: 0;
            animation: driftQuoteCloud linear infinite;
            max-width: 200px;
            line-height: 1.4;
        }

        /* SPARKLES */
        .sparkle-float {
            position: fixed;
            font-size: 14px;
            pointer-events: none;
            animation: sparkleFloat 8s ease-in-out forwards;
            z-index: 7;
        }

        /* WATERLINE */
        .mm-water {
            position: fixed;
            inset: auto 0 0 0;
            height: 28vh;
            pointer-events: none;
            z-index: 8;
            background:
                radial-gradient(60% 80% at 50% 0%,
                    rgba(199,229,245,.35), transparent 70%),
                linear-gradient(0deg,
                    rgba(250,249,246,.85),
                    rgba(250,249,246,0) 70%);
            mask-image: radial-gradient(
                120% 60% at 50% -10%,
                black 40%, transparent 70%
            );
            animation: tide 8s ease-in-out infinite;
        }

        /* MAIN CONTAINER */
        .container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
            transition: transform .3s ease;
            transform-style: preserve-3d;
        }

        .view { display: none; animation: fadeIn 1s ease; }
        .view.active { display: block; }

        /* LOGO + INVITE */
        .invitation-text {
            font-size: 1.05em;
            color: rgba(255,255,255,.85);
            text-align: center;
            margin-bottom: 24px;
            font-style: italic;
            text-shadow: 0 0 20px rgba(255,255,255,.6);
        }

        .logo {
            font-family: var(--font-title);
            text-align: center;
            font-size: var(--font-h1-mobile);
            animation: logoFloat 4s ease-in-out infinite;
            margin-bottom: 8px;
            text-transform: lowercase;
        }

        @media (min-width: 1024px) {
            .logo { font-size: var(--font-h1-desktop); }
        }

        .logo-text {
            background: linear-gradient(
                90deg,
                #F8F3FF, #FFF8FA, #F3FFFA,
                #FFFCF8, #FFF8FA, #F8F3FF
            );
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: holoShift 8s ease-in-out infinite;
        }

        .emoji {
            display: inline-block;
            margin-left: 8px;
            animation: emojiRotate 5s ease-in-out infinite;
        }

        .tagline {
            color: rgba(255,255,255,.8);
            font-size: 1em;
            text-align: center;
            margin-bottom: 32px;
            text-shadow: 0 0 20px rgba(255,255,255,.5);
        }

        /* GLASS CARD */
        .glass-card {
            background: rgba(255,255,255,.35);
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 20px;
            padding: 24px;
            backdrop-filter: blur(30px) saturate(180%);
            box-shadow: 0 8px 25px rgba(0,0,0,.12);
        }

        textarea {
            width: 100%;
            min-height: 180px;
            padding: 20px;
            border-radius: 16px;
            border: none;
            background: rgba(255,255,255,.5);
            resize: none;
            font-size: 1em;
            font-family: var(--font-body);
        }

        textarea:focus {
            outline: none;
            background: rgba(255,255,255,.75);
        }

        .submit-btn {
            margin-top: 20px;
            padding: 12px 0;
            width: 100%;
            text-align: center;
            border-radius: 999px;
            border: 2px solid rgba(255,255,255,.6);
            background: linear-gradient(135deg,#E8D8B8,#D8C8A8);
            color: white;
            font-weight: 500;
            text-transform: lowercase;
            cursor: pointer;
            font-family: var(--font-body);
            box-shadow: 0 8px 25px rgba(232,216,184,.3);
        }

        /* LOAD VIEW */
        .breathing-circle {
            width: 70px;
            height: 70px;
            margin: 0 auto 16px;
            border-radius: 50%;
            background: rgba(212,197,226,.5);
            animation: breathe 3s ease-in-out infinite;
        }

        .loading-text {
            text-align: center;
            color: rgba(255,255,255,.85);
            font-style: italic;
        }

        .loading-emoji {
            font-size: 1.6em;
            text-align: center;
            animation: pulse 2s ease infinite, float 3s ease-in-out infinite;
            margin-top: 12px;
        }

        /* RESULT CARD */
        .mm-card {
            background: rgba(255,255,255,.65);
            border-radius: 24px;
            padding: 24px;
            border: 1px solid rgba(255,255,255,.8);
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0,0,0,.12);
        }

        .mm-user-input {
            background: rgba(215,203,179,.1);
            padding: 12px;
            border-left: 2px solid rgba(215,203,179,.3);
            border-radius: 12px;
            margin-bottom: 16px;
            font-style: italic;
        }

        .mm-text {
            font-size: 18px;
            line-height: 1.7;
            color: var(--ink);
            margin-bottom: 16px;
        }
    </style>
</head>
<body>

    <!-- back to wtmt -->
    <a href="/" class="back-btn">
        <span>‚Üê</span><span>back to wtmt</span>
    </a>

    <!-- custom cursor (desktop only) -->
    <div class="custom-cursor"></div>
    <div class="cursor-follower"></div>

    <!-- aurora beams -->
    <div class="aurora-container">
        <div class="aurora-beam"></div>
        <div class="aurora-beam"></div>
        <div class="aurora-beam"></div>
        <div class="aurora-beam"></div>
        <div class="aurora-beam"></div>
    </div>

    <!-- ripple canvas -->
    <canvas id="rippleCanvas"></canvas>

    <!-- particles -->
    <div id="particleSystem" class="particle-system"></div>

    <!-- cloud layers -->
    <div id="cloudLayerBack" class="cloud-layer"></div>
    <div id="cloudLayerMid" class="cloud-layer"></div>
    <div id="cloudLayerFront" class="cloud-layer"></div>

    <!-- waterline -->
    <div class="mm-water" aria-hidden="true"></div>

    <!-- main container -->
    <div class="container" id="mainContainer">

        <!-- SUBMISSION VIEW -->
        <div id="submissionView" class="view active">
            <div class="invitation-text">
                close your eyes, take a breath.<br>
                now ‚Äî tell the mirror what's real.
            </div>

            <div class="logo">
                <span class="logo-text">magicmirror</span>
                <span class="emoji">ü™û‚ú®</span>
            </div>

            <p class="tagline">
                your truth, transformed withouttoomuchthought.
            </p>

            <div class="glass-card">
                <textarea
                    id="userInput"
                    maxlength="500"
                    placeholder="tell me what you're feeling..."
                ></textarea>

                <button class="submit-btn" onclick="submitThought()">
                    transform ü™û‚ú®
                </button>
            </div>

            <p class="footer-note" style="
                margin-top: 22px;
                text-align:center;
                color:rgba(255,255,255,.85);
                font-style:italic;
                line-height:1.6;
            ">
                write what's true.<br>
                messy. honest. unfiltered.<br>
                you're safe, you're seen, you're held. üíõ
            </p>
        </div>

        <!-- LOADING VIEW -->
        <div id="loadingView" class="view">
            <div class="breathing-circle"></div>
            <p class="loading-text">holding your words gently...</p>
            <div class="loading-emoji">ü™û‚ú®</div>
        </div>

        <!-- RESULT VIEW -->
        <div id="resultView" class="view">
            <article class="mm-card">

                <header class="mm-head" style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                    <span class="mm-logo" style="
                        width:24px;height:24px;border-radius:50%;
                        background:radial-gradient(circle at 30% 30%, var(--lilac), var(--peach));
                        box-shadow:0 2px 6px rgba(0,0,0,.08) inset;
                    "></span>

                    <h2 class="mm-title" style="
                        font-family:var(--font-title);
                        font-size:18px;
                        font-weight:600;
                        text-transform:lowercase;
                        color:var(--ink);
                    ">magicmirror</h2>
                </header>

                <div class="mm-whisper" style="
                    font-size:12px;
                    color:var(--text);
                    opacity:.55;
                    font-style:italic;
                    margin-bottom:6px;
                ">you wrote:</div>

                <div id="userInputDisplay" class="mm-user-input"></div>

                <section id="mm-mirror" class="mm-mirror" style="
                    background:rgba(255,255,255,.5);
                    border-radius:16px;
                    border:1px solid rgba(255,255,255,.7);
                    padding:18px;
                    margin-top:8px;
                    margin-bottom:16px;
                    position:relative;
                ">
                    <div id="mm-live" class="sr-only" aria-live="polite"></div>

                    <div id="transformedText" class="mm-text"></div>

                    <p id="mm-subtle" class="mm-subtle" style="
                        font-size:11px;
                        opacity:.55;
                        font-style:italic;
                        border-top:1px solid rgba(0,0,0,.04);
                        margin-top:10px;
                        padding-top:10px;
                        text-align:center;
                    ">a soft reflection by wtmt ¬∑ just now</p>
                </section>

                <!-- NO VOICE BUTTON ANYMORE -->

                <!-- SHARE BUTTON -->
                <button class="mm-action-btn" onclick="shareToSocial()" style="
                    background:rgba(255,255,255,.75);
                    border:none;
                    border-radius:16px;
                    padding:14px 18px;
                    width:100%;
                    display:flex;
                    gap:12px;
                    align-items:center;
                    text-align:left;
                    margin-top:10px;
                ">
                    <div class="action-icon" style="font-size:1.3em;">üå∏</div>
                    <div class="action-content">
                        <div class="action-title" style="font-weight:600;font-size:0.95em;color:var(--ink);">
                            share your truth
                        </div>
                        <div class="action-desc" style="font-size:0.8em;color:var(--text);opacity:.65;">
                            tiktok story, instagram, anywhere you want
                        </div>
                    </div>
                </button>

                <!-- DOWNLOAD BUTTON -->
                <button class="mm-action-btn" onclick="downloadArt()" style="
                    background:rgba(255,255,255,.75);
                    border:none;
                    border-radius:16px;
                    padding:14px 18px;
                    width:100%;
                    margin-top:10px;
                    display:flex;
                    gap:12px;
                    text-align:left;
                    align-items:center;
                ">
                    <div class="action-icon" style="font-size:1.3em;">üé®</div>
                    <div class="action-content">
                        <div class="action-title" style="font-weight:600;font-size:0.95em;">download as art</div>
                        <div class="action-desc" style="font-size:0.8em;color:var(--text);opacity:.65;">
                            save this as a beautiful reminder
                        </div>
                    </div>
                </button>

                <div class="support-box" style="
                    margin-top:16px;
                    padding:16px;
                    background:rgba(253,242,179,0.1);
                    border-radius:16px;
                    text-align:center;
                    border:1px solid rgba(253,242,179,0.2);
                ">
                    <p class="support-text" style="
                        font-size:0.85em;
                        opacity:.75;
                        font-style:italic;
                        margin-bottom:12px;
                        line-height:1.4;
                    ">
                        if this reflection held something for you,<br>
                        you can help keep this space free üïØÔ∏è
                    </p>

                    <a href="https://buymeacoffee.com/withouttoomuchthought"
                       target="_blank"
                       class="support-link"
                       style="
                           display:inline-block;
                           padding:8px 18px;
                           border-radius:999px;
                           background:linear-gradient(135deg, var(--butter), var(--gold));
                           font-size:0.85em;
                           font-weight:500;
                           color:var(--ink);
                           text-decoration:none;
                       ">
                        leave a little light ‚ú®
                    </a>
                </div>

                <button class="mm-try-again" onclick="tryAgain()" style="
                    margin-top:14px;
                    padding:10px;
                    width:100%;
                    background:transparent;
                    color:var(--text);
                    font-size:13px;
                    opacity:.7;
                    border:none;
                    text-transform:lowercase;
                ">
                    share another truth ü™û
                </button>

            </article>
        </div>

    </div>

    <!-- floating buymeacoffee -->
    <a href="https://buymeacoffee.com/withouttoomuchthought"
       class="bmac-button"
       target="_blank"
       style="
           position:fixed;
           bottom:16px;
           left:16px;
           padding:10px 16px;
           background:rgba(255,255,255,.45);
           backdrop-filter:blur(20px);
           border-radius:999px;
           border:2px solid rgba(249,228,166,.3);
           font-size:0.85em;
           font-style:italic;
           color:var(--ink);
           text-decoration:none;
           z-index:100;
       ">
        <span class="bmac-emoji" style="font-size:1.2em;">‚òïÔ∏è</span>
        <span>support this space</span>
    </a>

    <a href="https://www.withouttoomuchthought.com"
       class="wtmt-link"
       style="
           position:fixed;
           bottom:16px;
           right:16px;
           font-size:0.75em;
           color:rgba(255,255,255,.75);
           text-decoration:none;
           font-style:italic;
           text-shadow:0 0 10px rgba(255,255,255,.5);
           z-index:100;
       ">
        withouttoomuchthought.com
    </a>
<script>
/* -----------------------------------------------------
   MAGICMIRROR CORE CONFIG
----------------------------------------------------- */
const WEBHOOK_URL = 'https://magicmirror.withouttoomuchthought.workers.dev/';
const DEBUG = new URLSearchParams(window.location.search).get('debug') === 'true';
const log = (...a) => DEBUG && console.log('[magicmirror]', ...a);

/* -----------------------------------------------------
   RESPONSIVE BACKGROUND (TIME-BASED)
----------------------------------------------------- */
function setTimeBasedGradient() {
    const hour = new Date().getHours();
    const r = document.documentElement;

    if (hour >= 6 && hour < 12) {
        r.style.setProperty('--gradient-1', '#C8B8E8');
        r.style.setProperty('--gradient-2', '#B8C8E8');
        r.style.setProperty('--gradient-3', '#B8D8E8');
        r.style.setProperty('--gradient-4', '#C8C8E8');
    } else if (hour >= 12 && hour < 18) {
        r.style.setProperty('--gradient-1', '#A8B8E8');
        r.style.setProperty('--gradient-2', '#B8A8E8');
        r.style.setProperty('--gradient-3', '#A8C8E8');
        r.style.setProperty('--gradient-4', '#B8B8E8');
    } else if (hour >= 18 && hour < 22) {
        r.style.setProperty('--gradient-1', '#9888C8');
        r.style.setProperty('--gradient-2', '#8898D8');
        r.style.setProperty('--gradient-3', '#9888D8');
        r.style.setProperty('--gradient-4', '#A898D8');
    } else {
        r.style.setProperty('--gradient-1', '#7868A8');
        r.style.setProperty('--gradient-2', '#6878B8');
        r.style.setProperty('--gradient-3', '#7868B8');
        r.style.setProperty('--gradient-4', '#8878B8');
    }
}
setTimeBasedGradient();
setInterval(setTimeBasedGradient, 3600000);

/* -----------------------------------------------------
   PLACEHOLDER ROTATION
----------------------------------------------------- */
const prompts = [
    "tell me what you're feeling...",
    "what's on your heart?",
    "what are you carrying today?",
    "what truth wants to be held?",
    "what's been heavy lately?",
    "what do you need to release?"
];
let promptIndex = 0;

setInterval(() => {
    const t = document.getElementById('userInput');
    if (!t) return;
    t.placeholder = prompts[promptIndex];
    promptIndex = (promptIndex + 1) % prompts.length;
}, 4000);

/* -----------------------------------------------------
   LOADING MESSAGES
----------------------------------------------------- */
const loadingMessages = [
    "holding your words gently...",
    "seeing what you didn't say...",
    "listening for your truth...",
    "reflecting back your heart...",
    "finding the right words..."
];
let loadingIndex = 0, loadingInterval;

function startLoadingText() {
    const el = document.querySelector('.loading-text');
    loadingIndex = 0;
    el.textContent = loadingMessages[0];

    loadingInterval = setInterval(() => {
        loadingIndex = (loadingIndex + 1) % loadingMessages.length;
        el.style.opacity = 0;
        setTimeout(() => {
            el.textContent = loadingMessages[loadingIndex];
            el.style.opacity = 1;
        }, 300);
    }, 2500);
}
function stopLoadingText() { clearInterval(loadingInterval); }

/* -----------------------------------------------------
   RIPPLE EFFECT
----------------------------------------------------- */
const rippleCanvas = document.getElementById('rippleCanvas');
const rippleCtx = rippleCanvas.getContext('2d');
let ripples = [];

function resizeRippleCanvas() {
    rippleCanvas.width = window.innerWidth;
    rippleCanvas.height = window.innerHeight;
}
resizeRippleCanvas();
window.addEventListener('resize', resizeRippleCanvas);

document.addEventListener('click', (e) => {
    ripples.push({
        x: e.clientX,
        y: e.clientY,
        radius: 0,
        maxRadius: 140,
        alpha: 1
    });
});

function animateRipples() {
    rippleCtx.clearRect(0, 0, rippleCanvas.width, rippleCanvas.height);

    ripples = ripples.filter(r => {
        r.radius += 2.8;
        r.alpha -= 0.015;

        if (r.alpha <= 0) return false;

        rippleCtx.beginPath();
        rippleCtx.arc(r.x, r.y, r.radius, 0, Math.PI * 2);
        rippleCtx.strokeStyle = `rgba(212, 197, 226, ${r.alpha * 0.6})`;
        rippleCtx.lineWidth = 2;
        rippleCtx.stroke();

        return true;
    });

    requestAnimationFrame(animateRipples);
}
animateRipples();

/* -----------------------------------------------------
   PARTICLES
----------------------------------------------------- */
function createParticles() {
    const container = document.getElementById('particleSystem');
    if (!container) return;

    const add = (count, cls, durationMin, durationMax, drift) => {
        for (let i = 0; i < count; i++) {
            const p = document.createElement('div');
            p.className = 'particle ' + cls;
            p.style.left = Math.random() * 100 + '%';
            p.style.animationDuration = (durationMin + Math.random() * (durationMax - durationMin)) + 's';
            p.style.setProperty('--particle-drift', ((Math.random() - 0.5) * drift) + 'px');
            container.appendChild(p);
        }
    };

    add(14, 'slow', 12, 20, 80);
    add(12, 'fast', 8, 14, 100);
    add(8,  'glow', 10, 18, 140);
}
createParticles();

/* -----------------------------------------------------
   CLOUDS + QUOTE CLOUDS
----------------------------------------------------- */
const healingQuotes = [
    "real love doesn't\nkeep score...",
    "you don't have to be strong\nto be worthy...",
    "maybe it's time\nto be soft...",
    "strength became your default\nbecause weakness wasn't safe...",
    "you're not failing ‚Äî\nyou're protecting...",
    "this isn't weakness ‚Äî\nthis is grief...",
    "you're allowed to be\nuncertain...",
    "what if this is exactly\nwhere you need to be?",
    "your truth matters,\neven when it's quiet...",
    "healing isn't linear,\nand that's okay...",
    "you're doing better\nthan you think...",
    "being seen\ndoesn't require being perfect...",
    "your feelings\nare valid...",
    "it's okay to not be okay\nright now...",
    "being soft\nis strength...",
];

function createCloudLayers() {
    const layers = [
        { el: 'cloudLayerBack',  count: 7, size: [80,140], speed: [35,45], opacity: 0.3 },
        { el: 'cloudLayerMid',   count: 6, size: [110,170], speed: [25,35], opacity: 0.5 },
        { el: 'cloudLayerFront', count: 5, size: [130,190], speed: [18,28], opacity: 0.7 }
    ];

    layers.forEach(layer => {
        const container = document.getElementById(layer.el);
        if (!container) return;

        for (let i = 0; i < layer.count; i++) {
            const c = document.createElement('div');
            c.className = 'parallax-cloud';

            const sz = layer.size[0] + Math.random() * (layer.size[1] - layer.size[0]);
            c.style.width = sz + 'px';
            c.style.height = (sz * 0.6) + 'px';

            c.style.left = Math.random() * 95 + '%';
            c.style.animationDuration = (layer.speed[0] + Math.random() * (layer.speed[1] - layer.speed[0])) + 's';
            c.style.animationDelay = (Math.random() * 20) + 's';

            c.style.setProperty('--cloud-drift', ((Math.random() - 0.4) * 120) + '%');
            c.style.setProperty('--cloud-opacity', layer.opacity);

            container.appendChild(c);
        }
    });
}

function createQuoteClouds() {
    const front = document.getElementById('cloudLayerFront');
    if (!front) return;

    for (let i = 0; i < 7; i++) {
        const q = document.createElement('div');
        q.className = 'quote-cloud';
        q.textContent = healingQuotes[Math.floor(Math.random() * healingQuotes.length)];

        q.style.left = Math.random() * 90 + '%';
        q.style.animationDuration = (20 + Math.random() * 18) + 's';
        q.style.animationDelay = Math.random() * 20 + 's';

        q.style.setProperty('--quote-drift', ((Math.random() - 0.4) * 130) + '%');
        q.style.setProperty('--quote-rotate', ((Math.random() - 0.5) * 18) + 'deg');

        front.appendChild(q);
    }
}

createCloudLayers();
createQuoteClouds();

/* -----------------------------------------------------
   SPARKLES
----------------------------------------------------- */
setInterval(() => {
    if (Math.random() > 0.55) return;
    const s = document.createElement('div');
    s.className = 'sparkle-float';
    s.textContent = Math.random() > 0.5 ? '‚ú®' : 'üí´';
    s.style.left = Math.random() * 100 + '%';
    s.style.top = Math.random() * 100 + '%';
    document.body.appendChild(s);
    setTimeout(() => s.remove(), 8000);
}, 3500);

/* -----------------------------------------------------
   CELEBRATION BURST
----------------------------------------------------- */
function celebration() {
    const container = document.getElementById('particleSystem');
    if (!container) return;
    for (let i = 0; i < 28; i++) {
        const p = document.createElement('div');
        p.className = 'particle glow';
        const angle = (360 / 28) * i;
        const dist = 5 + Math.random() * 12;
        const left = 50 + Math.cos(angle * Math.PI/180) * dist;
        p.style.left = left + '%';
        p.style.bottom = '50%';
        p.style.animationDuration = (2 + Math.random()*2) + 's';
        p.style.setProperty('--particle-drift', ((Math.random() - .5)*200)+'px');
        container.appendChild(p);
        setTimeout(() => p.remove(), 2600);
    }
}

/* -----------------------------------------------------
   3D PARALLAX (DESKTOP)
----------------------------------------------------- */
const container3D = document.getElementById('mainContainer');

container3D.addEventListener('mousemove', (e) => {
    if (window.innerWidth < 760) return;
    const r = container3D.getBoundingClientRect();
    const x = e.clientX - r.left;
    const y = e.clientY - r.top;
    const rotateX = (y - r.height / 2) / 32;
    const rotateY = (r.width / 2 - x) / 32;
    container3D.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
});
container3D.addEventListener('mouseleave', () => {
    container3D.style.transform = 'perspective(1000px) rotateX(0) rotateY(0)';
});

/* -----------------------------------------------------
   MOBILE TILT SUPPORT
----------------------------------------------------- */
if (window.DeviceOrientationEvent && /iPhone|Android/i.test(navigator.userAgent)) {
    window.addEventListener('deviceorientation', (e) => {
        if (!e.gamma || !e.beta) return;
        const x = e.beta / 18;
        const y = e.gamma / 18;
        container3D.style.transform = `perspective(1000px) rotateX(${x}deg) rotateY(${y}deg)`;
    });
}

/* -----------------------------------------------------
   COPY BUTTON
----------------------------------------------------- */
function toast(msg) {
    const t = document.createElement('div');
    t.textContent = msg;
    Object.assign(t.style, {
        position: 'fixed',
        left: '50%',
        bottom: '24px',
        transform: 'translateX(-50%)',
        background: 'rgba(255,255,255,.95)',
        padding: '10px 16px',
        borderRadius: '999px',
        fontFamily: 'Karla',
        color: '#2F2F2F',
        boxShadow: '0 8px 20px rgba(0,0,0,.12)',
        zIndex: 9999,
        transition: 'opacity .3s'
    });
    document.body.appendChild(t);
    setTimeout(() => t.style.opacity = '0', 1000);
    setTimeout(() => t.remove(), 1400);
}

/* -----------------------------------------------------
   SHARE TO SOCIAL (story image)
----------------------------------------------------- */
function wrapLines(ctx, text, x, y, maxW, lh) {
    const words = text.split(' ');
    let line = '';
    words.forEach(w => {
        const test = line + w + ' ';
        if (ctx.measureText(test).width > maxW && line !== '') {
            ctx.fillText(line, x, y);
            line = w + ' ';
            y += lh;
        } else {
            line = test;
        }
    });
    ctx.fillText(line, x, y);
    return y + lh;
}

function createStoryCanvas() {
    const canvas = document.createElement('canvas');
    canvas.width = 1080;
    canvas.height = 1920;

    const ctx = canvas.getContext('2d');

    // gradient bg
    const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
    grad.addColorStop(0, '#B8A8D8');
    grad.addColorStop(.5, '#A8B8E8');
    grad.addColorStop(1, '#C8B8E8');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // card
    ctx.fillStyle = 'rgba(255,255,255,.45)';
    ctx.shadowColor = 'rgba(0,0,0,.15)';
    ctx.shadowBlur = 35;
    ctx.shadowOffsetY = 18;

    const cardX = 90, cardY = 180, cardW = canvas.width - 180, cardH = canvas.height - 380;
    ctx.beginPath();
    ctx.roundRect(cardX, cardY, cardW, cardH, 40);
    ctx.fill();
    ctx.shadowColor = 'transparent';

    // text
    ctx.fillStyle = '#2F2F2F';
    ctx.font = 'italic 40px Karla';
    const message = document.getElementById('transformedText').innerText;
    wrapLines(ctx, message, cardX + 60, cardY + 80, cardW - 120, 58);

    // footer
    ctx.fillStyle = 'rgba(47,47,47,.6)';
    ctx.font = '26px Karla';
    ctx.textAlign = 'center';
    ctx.fillText('transformed with love by magicmirror ü™û‚ú®', canvas.width/2, canvas.height - 240);
    ctx.font = '24px Karla';
    ctx.fillText('@withouttoomuchthought', canvas.width/2, canvas.height - 190);

    return canvas;
}

function shareToSocial() {
    const canvas = createStoryCanvas();
    canvas.toBlob(async (blob) => {
        const file = new File([blob], 'magicmirror.png', {type:'image/png'});
        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            try {
                await navigator.share({
                    files: [file],
                    title: 'my truth, transformed',
                    text: 'shared from magicmirror ü™û‚ú®'
                });
                return;
            } catch {}
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'magicmirror.png';
        a.click();
        URL.revokeObjectURL(url);
        toast('saved!');
    }, 'image/png');
}

function downloadArt() {
    const canvas = createStoryCanvas();
    canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'magicmirror.png';
        a.click();
        URL.revokeObjectURL(url);
        toast('saved!');
    });
}

/* -----------------------------------------------------
   MAGICMIRROR SUBMIT LOGIC
----------------------------------------------------- */
let currentUserInput = '';

async function submitThought() {
    const input = document.getElementById('userInput').value.trim();
    if (!input) {
        alert('share something first, love üíõ');
        return;
    }

    currentUserInput = input;

    document.getElementById('submissionView').classList.remove('active');
    document.getElementById('loadingView').classList.add('active');
    startLoadingText();

    try {
        const res = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ original_text: input, user_ip: 'browser' })
        });

        const data = await res.json();
        stopLoadingText();
        document.getElementById('loadingView').classList.remove('active');

        if (!data.success || !data.transformed) {
            throw new Error('Invalid response');
        }

        document.getElementById('userInputDisplay').innerText = `"${currentUserInput}"`;
        document.getElementById('transformedText').innerText = data.transformed;

        document.getElementById('resultView').classList.add('active');
        celebration();

        window.scrollTo({ top: 0, behavior: 'smooth' });

    } catch (err) {
        stopLoadingText();
        document.getElementById('loadingView').classList.remove('active');
        document.getElementById('submissionView').classList.add('active');
        alert('something went wrong ‚Äî try again üíõ');
    }
}

/* ENTER KEY SUBMIT */
document.getElementById('userInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        submitThought();
    }
});

/* TRY AGAIN */
function tryAgain() {
    document.getElementById('resultView').classList.remove('active');
    document.getElementById('submissionView').classList.add('active');
    document.getElementById('userInput').value = '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>

